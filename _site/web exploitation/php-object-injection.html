<!DOCTYPE html>
<html>
<!--
====================================================
       _         _ _ _       _            ___ 
      | |       | (_) |     | |          / __)
  ____| | _   _ | |_| | ____| | _   ____| |__ 
 / _  | || \ / || | | |/ _  | || \ / ___)  __)
( ( | | |_) | (_| | | ( ( | | | | | |   | |   
 \_||_|____/ \____|_|_|\_||_|_| |_|_|   |_|  
 
====================================================
@ABDILAHRF
====================================================
-->
<head>
<meta charset="utf-8">
<title>PHP OBJECT INJECTION VIA UNSERIALIZE &vert; @ABDILAHRF</title>
<meta name="description" content="PHP Object Injection Via Unserialize">
<meta name="keywords" content="Web Exploitation">

<!-- Twitter Cards -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="/images/php.jpg">

<meta name="twitter:title" content="PHP Object Injection Via Unserialize">
<meta name="twitter:description" content="PHP Object Injection Via Unserialize">
<meta name="twitter:creator" content="@abdilahrf">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="PHP Object Injection Via Unserialize">
<meta property="og:description" content="PHP Object Injection Via Unserialize">
<meta property="og:url" content="http://localhost:4000/web%20exploitation/php-object-injection">
<meta property="og:site_name" content="@abdilahrf">
<meta property="og:image" content="http://localhost:4000/images//images/php.jpg">





<link rel="canonical" href="http://localhost:4000/web%20exploitation/php-object-injection">
<link href="http://localhost:4000/feed.xml" type="application/atom+xml" rel="alternate" title="@abdilahrf Feed">
<link rel="author" href="https://plus.google.com/?rel=author">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />


    <link href='http://fonts.googleapis.com/css?family=Montserrat:400,700|Open+Sans:400,600,300,800,700' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" href="http://localhost:4000/assets/css/vendor/font-awesome.min.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/vendor/normalize.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/vendor/nprogress.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/vendor/foundation.min.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/style.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/post.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/code/monokai.css">





<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="http://localhost:4000/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="http://localhost:4000/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="http://localhost:4000/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://localhost:4000/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://localhost:4000/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://localhost:4000/images/apple-touch-icon-144x144-precomposed.png">

<style type="text/css">@media only screen and (min-width:43.75em){.notepad-post-content div>p:first-child:first-letter{float:left;font-size:4.688rem;line-height:4.375rem;padding-top:.25rem;padding-right:.5rem;padding-left:.188rem;font-family:serif}}</style>
</head>
<body class="post-template" itemscope itemtype="http://schema.org/WebPage">  

        <main id="notepad-post-container" class="notepad-post-container intro-effect-sliced" role="main">
            <header class="notepad-post-header">
                <div class="bg-img"></div>
                
                <div class="notepad-post-menu-header">

                    <a class="notepad-blog-logo" href="http://localhost:4000">
                        <img src="http://localhost:4000/images/logo.png" alt="Blog Logo" />
                    </a>

                <div class="notepad-blog-menu">      
    <div class="notepad-mobile-menu show-for-small">
        <a href="#"><i class="fa fa-bars"></i></a>
    </div>
    <ul class="notepad-menu">
        <li class="notepad-mobile-close-btn show-for-small text-right">
            <a href="#"><i class="fa fa-times"></i></a>
        </li>

            <li>
                    <a href="http://localhost:4000/">Home</a>
                 </li>

            <li>
                    <a href="http://localhost:4000/featured">Featured Posts</a>
                 </li>

            <li>
                    <a href="http://localhost:4000/categories">Categories</a>
                 </li>

            <li>
                    <a href="http://localhost:4000/about">About</a>
                 </li>
            
           <li><a href="http://localhost:4000/feed.xml" title="Atom/RSS feed"><i class="icon-rss"></i> Feed</a></li>
    </ul>

</div>
            </div>

            <div class="notepad-post-title bg-check">
                <h1>PHP Object Injection Via Unserialize</h1>
                <p>by <strong>Abdillah Muhamad</strong> &#8212; on <a href="http://localhost:4000/tags/index.html#Web Exploitation" data-toggle="tooltip" title="Posts tagged with Web Exploitation" rel="tag">Web Exploitation</a> <strong><!-- <time datetime="2016-10-01 00:00:00 +0700">2016-10-01 00:00:00 +0700</time> --></strong></p>
            </div>
            <div class="bg-img"></div>
        </header>
        <button class="trigger bg-check" data-info="Read more"><span>Trigger</span></button>
        <img src="/images/php.jpg" alt="cover-image" />

        <article class="notepad-post-content post">
            <div><p>PHP Unserialize bisa menjadi petaka ketika kita mengambil atau menggunakan input
dari user untuk di eksekusi ke unserialize(), dalam dokumentasi fungsi <a href="http://php.net/manual/en/function.unserialize.php">unserialize()</a> di php.net
kita sudah di beri warning untuk tidak menggunakan input dari user karena bisa
berdampak code execution pada saat object insantiation atau autoloading, untuk keamanan
kita bisa menggunakan <a href="http://php.net/manual/en/function.json-decode.php">json_encode()</a> atau <a href="http://php.net/manual/en/function.json-encode.php">json_decode()</a> sebagai standar pertukaran data.</p>

<p>Sebelum melanjut ke tahap melakukan exploitasi pada kasus yang vulnerable mari kita pahami
apa yang di lakukan oleh fungsi <a href="http://php.net/manual/en/function.serialize.php">serialize()</a> dan <a href="http://php.net/manual/en/function.unserialize.php">unserialize()</a></p>

<h2 id="serialize">Serialize</h2>

<p><code>string serialize ( mixed $value )</code></p>

<p><a href="http://php.net/manual/en/function.serialize.php">serialize()</a> menerima input satu parameter yaitu
value yang ingin di serialize dalam bentuk apapun kecuali <a href="http://php.net/manual/en/language.types.resource.php">resource</a>-type
Return value yang di kembalikan adalah byte-stream representasi dari value.</p>

<h4 id="contoh">Contoh</h4>

<pre><code class="language-php">&lt;?php
$myArr = array("PHP","IS","NICE");
$serialized = serialize($myArr);
print $serialized;
?&gt;
</code></pre>
<p>Output : <code>a:3{i:0;s:3:"PHP";i:1;s:2:"IS";i:2;s:4:"NICE";}</code></p>

<ul>
  <li><code>a:3{</code>          : Array dari 3 value</li>
  <li><code>i:0;</code>          : Integer, Index ke [0]</li>
  <li><code>s:3:"PHP"</code>     : String, 3 karakter, Value “PHP”</li>
  <li><code>i:1;</code>          : Integer, Index ke [1]</li>
  <li><code>s:2:"IS"</code>      : String, 2 karakter, Value “IS”</li>
  <li><code>i:2;</code>          : Integer, Index ke [2]</li>
  <li><code>s:4:"NICE"}</code>   : String, 4 karakter, Value “NICE”</li>
</ul>

<p>Kira-kira seperti itu penjabaran dari serialize nya.</p>

<h2 id="unserialize">Unserialize()</h2>

<p><code>mixed unserialize ( string $str [, array $options ] )</code></p>

<p><em><a href="http://php.net/manual/en/function.unserialize.php">unserialize()</a>  takes a single serialized variable and converts it back into a PHP value.</em>
Jadi unserialize melakukan konversi dari serialize object kedalam kode PHP kembali.</p>

<p>selain menggunakan json sebagai standar pertukaran data Saran lain dari dokumentasi 
php.net adalah untuk menggunakan <a href="http://php.net/manual/en/function.hash-hmac.php">hmac</a>
untuk melakukan validasi dan menjaga data tidak ada yang memodifikasi selain dari yang di tentukan server.</p>

<p>Note : $options parameter baru ada di changelog php 7.0.0</p>

<h4 id="contoh-1">Contoh</h4>

<pre><code class="language-php">&lt;?php
$value='a:1:{s:4:"Test";s:17:"Unserializationhere!";}'
unserialize($value);
?&gt;
</code></pre>

<h2 id="php-autoloading">PHP Autoloading</h2>

<p>Dalam php kita bisa mendifinisikan special function yang bisa di exsekusi secara otomatis
jadi untuk menjalankannya tidak perlu panggil fungsinya lagi biasanya disebut dengan php magic function atau magic method
php juga mempunyai beberapa magic method seperti __construct/__destruct.</p>

<p>Contoh beberapa magic function di php : __construct(), __destruct(), __call(), __callSt
atic(), __get(), __set(), __isset(), __unset(), __sleep(), __wakeup(), __toString(), __invoke(), __set_state(), __clone(), and __autoload().</p>

<p>Ref: http://www.programmerinterview.com/index.php/php-questions/php-what-are-magic-functions/</p>

<h2 id="object-instantiation">Object Instantiation</h2>

<p>Instantiation adalah ketika class menjadi objek saat kita buat instance dari class tersebut
contohnya ketika kita buat <code>new namaClass()</code> , namaClass() jadi instantiated object</p>

<h2 id="exploit-the-vulnerable-code">Exploit the vulnerable code</h2>

<pre><code class="language-php">&lt;?php

class foo {
	public $file = "text.txt";
	public $data = "stringnya";

	// php magic function
	function __destruct(){
		file_put_contents($this-&gt;file, $this-&gt;data);
	}
}

$file_name = $_GET['session_filename'];

print "Readfile " . $file_name . "&lt;br&gt;";
if(!file_exists($file_name)){
	print "no file\n";
}else{
	unserialize(file_get_contents($file_name));
}

?&gt;
</code></pre>

<p>pertama kita lihat apakah class yang vulnerable memanggil magic function dari php, 
jika iya berarti kita mungkin untuk mengubah flow dari applikasi tersebut.</p>

<p>code vulnerable di atas memanggil <code>__destruct()</code></p>

<pre><code class="language-php">&lt;?php
class foo {
	public $file = "text.txt";
	public $data = "stringnya";

	// php magic function
	function __destruct(){
		file_put_contents($this-&gt;file, $this-&gt;data);
	}
}

</code></pre>

<h4 id="racik-payload">Racik payload</h4>

<p><code>O:3:%22foo%22:2:{s:4:%22file%22;s:9:%22shell.php%22;s:4:%22data%22;s:5:%22aaaa%22;}</code></p>

<ul>
  <li><code>O:3:</code>                            : Object, terima 3 parameter</li>
  <li><code>"foo":2:{</code>                       : Parameter foo terima 2 value</li>
  <li><code>s:4:"file";s:9:"shell.php";</code>     : String, 4 karakter “file”,String 9 karakter “shell.php”</li>
  <li><code>s:4:"data";s:5:"aaaa";}</code>         : String, 4 karakter “data”,String 5 karakter “aaaaa”</li>
</ul>

<p>Ketika input string kita di unserialized maka kita dapat mengontrol properti dar class “foo”.
Di dalam magic method __destruct maka akan menggunakan
value yang sudah kita kontrol dan akan membuat file shell.php dengan isi “aaaaa”.</p>

<h2 id="patch-the-vulnerable-code">Patch the vulnerable code</h2>

<p>Lakukan validasi terhadap user input. dan gunakan json untuk pertukaran data.
bila memang harus menggunakan external serialize bisa juga tambahkan validasi dengan hmac()
atau lain sebagainya agar tidak ada input yang bisa mengexploitasi sistem.</p>

<p>References :</p>

<ul>
  <li>https://www.notsosecure.com/remote-code-execution-via-php-unserialize/</li>
  <li>https://securitycafe.ro/2015/01/05/understanding-php-object-injection/</li>
  <li>http://www.inulledmyself.com/2015/02/exploiting-memory-corruption-bugs-in.html</li>
  <li>https://www.owasp.org/index.php/PHP_Object_Injection</li>
</ul>
</div>
        </article>
        <div class="cf"></div>
        <div class="row text-center">
            <section class="notepad-post-share">
                <a class="twitter-icon" href="https://twitter.com/intent/tweet?text=&quot;PHP Object Injection Via Unserialize&quot;%20http://localhost:4000/web%20exploitation/php-object-injection%20via%20&#64;abdilahrf"
                    onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;" title="Share on Twitter">
                    <i class="fa fa-twitter"></i>
                </a>
                <a class="facebook-icon" href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/web%20exploitation/php-object-injection"
                    onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;" title="Share on Facebook">
                    <i class="fa fa-facebook"></i>
                </a>
                <a class="google-icon" href="https://plus.google.com/share?url=http://localhost:4000/web%20exploitation/php-object-injection"
                   onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;" title="Share on Google+">
                    <i class="fa fa-google-plus"></i>
                </a>
            </section>
        </div>
        <div class="cf"></div>
        
            <div class="notepad-author-info">
                <div class="row">
                    <section class="notepad-post-author small-12 columns">
                        
                            <img src="https://avatars2.githubusercontent.com/u/6015012?v=3&s=460" class="notepad-post-author-avatar" alt="Abdillah Muhamad's photo">
                        
                        
                            <span class="author-label">Author</span>
                            <h1>Abdillah Muhamad</h1>
                        
                        
                            <p><a href="mailto:hasny1337@gmail.com" class="author-website">hasny1337@gmail.com</a></p>
                        
                        
                            <p>Coffe make you like a hero</p>
                        
                    </section>
                </div>
            </div>
 
        
        <div class="cf"></div>
        
        <section class="notepad-disqus row">
    <div class="small-12 columns">
        <h1 class="notepad-comments-header">Comments</h1>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'abdilahrf'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>
</section>

        <div class="cf"></div>

    <footer class="notepad-site-footer">
    <div class="copyright">
         <section>All content copyright <a href="http://localhost:4000/about">Abdillah Muhamad</a> &copy; 2017 &bull; All rights reserved.</section>
         <section>Proudly published with <a class="icon-ghost" href="https://jekyllrb.com/">Jekyll</a></section>
    </div>
    <div class="social-icons">
        
        
        <a href="http://twitter.com/abdilahrf">
            <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x fa-inverse"></i>
                <i class="fa fa-twitter fa-stack-1x"></i>
            </span>
        </a>
        
        
        <a href="https://plus.google.com/">
            <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x fa-inverse"></i>
                <i class="fa fa-google-plus fa-stack-1x"></i>
            </span>
        </a>
        
        
        
        <a href="http://github.com/abdilahrf">
            <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x fa-inverse"></i>
                <i class="fa fa-github fa-stack-1x"></i>
            </span>
        </a>
        
        
        <a href="http://facebook.com/abdilah.jk">
            <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x fa-inverse"></i>
                <i class="fa fa-facebook fa-stack-1x"></i>
            </span>
        </a>
        
    </div>
    
    <div class="cf"></div>
</footer> 
</main>    
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <script>window.jQuery || document.write('<script src="http://localhost:4000/assets/js/vendor/jquery-1.11.1.min.js"><\/script>')</script>
    <script src="http://localhost:4000/assets/js/vendor/modernizr.js"></script>
    <script src="http://localhost:4000/assets/js/foundation.min.js"></script>
    <script src="http://localhost:4000/assets/js/vendor/background-check.js"></script>
    <script src="http://localhost:4000/assets/js/vendor/post-header-animations.js"></script>
    <script src="http://localhost:4000/assets/js/notepad.js"></script>
    <script src="http://localhost:4000/assets/js/scripts.min.js"></script>
    <script src="http://localhost:4000/assets/js/vendor/nprogress.js"></script>

    <script>
      $(document).foundation();
    </script>
    <script type='text/javascript'>console.log("@abdilahrf");</script>
    <script type='text/javascript'>console.log("https://abdilahrf.me");</script>


<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-96190645-1', 'auto');
  ga('require', 'displayfeatures');
  ga('send', 'pageview');

</script>

<script>NProgress.start();var interval=setInterval(function(){NProgress.inc()},1000);jQuery(window).load(function(){clearInterval(interval);NProgress.done()});jQuery(window).unload(function(){NProgress.start()});</script>
 
</body>
</html>